<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DHR Leads</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0e17;--card:#111827;--border:#1f2937;--text:#e5e7eb;--dim:#6b7280;--green:#10b981;--red:#ef4444;--blue:#3b82f6;--amber:#f59e0b}
body{font-family:-apple-system,system-ui,sans-serif;background:var(--bg);color:var(--text);padding:20px}
h1{font-size:22px;margin-bottom:20px;color:var(--green)}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:24px}
.stat{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:16px}
.stat-label{font-size:11px;color:var(--dim);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}
.stat-val{font-size:24px;font-weight:700}
.stat-val.g{color:var(--green)}.stat-val.b{color:var(--blue)}.stat-val.r{color:var(--red)}.stat-val.a{color:var(--amber)}
.toolbar{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap;align-items:center}
input[type=text],select{padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:#1a1f2e;color:var(--text);font-size:13px}
input:focus{outline:none;border-color:var(--green)}
.chip{padding:5px 14px;border-radius:20px;font-size:12px;cursor:pointer;border:1px solid var(--border);background:transparent;color:var(--dim);transition:.2s}
.chip:hover,.chip.on{border-color:var(--green);color:var(--green);background:rgba(16,185,129,.1)}
.btn{padding:8px 16px;border-radius:8px;border:none;font-size:13px;font-weight:600;cursor:pointer}
.btn-g{background:var(--green);color:#fff}.btn-g:hover{background:#059669}
.btn-s{background:#1a1f2e;color:var(--dim);border:1px solid var(--border)}.btn-s:hover{color:var(--text)}
table{width:100%;border-collapse:collapse;margin-top:8px}
th{padding:10px 12px;text-align:left;font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:.5px;background:#0d1117;border-bottom:1px solid var(--border)}
td{padding:10px 12px;font-size:13px;border-bottom:1px solid rgba(255,255,255,.04)}
tr:hover td{background:rgba(255,255,255,.02)}
.ok{color:var(--green)}.nok{color:var(--red)}.empty{color:var(--dim)}
.wa{color:var(--green);text-decoration:none;font-size:12px}.wa:hover{text-decoration:underline}
.tag{display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:600}
.tag-g{background:rgba(16,185,129,.15);color:var(--green)}
.tag-a{background:rgba(245,158,11,.15);color:var(--amber)}
.tabs{display:flex;gap:4px;margin-bottom:20px}
.tab{padding:8px 18px;border-radius:8px;cursor:pointer;font-size:13px;font-weight:500;color:var(--dim);background:transparent;border:none}
.tab:hover{color:var(--text)}.tab.on{color:var(--green);background:rgba(16,185,129,.1)}
.panel{display:none}.panel.on{display:block}
.log{background:var(--card);border:1px solid var(--border);border-radius:10px;max-height:400px;overflow-y:auto;padding:8px;font-family:monospace;font-size:11px}
.log div{padding:4px 8px;border-bottom:1px solid rgba(255,255,255,.03)}
.log .t{color:var(--dim);margin-right:8px}
.toast{position:fixed;bottom:20px;right:20px;padding:12px 24px;border-radius:10px;font-size:13px;font-weight:500;background:#065f46;color:#a7f3d0;z-index:99;animation:si .3s}
@keyframes si{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
.count{font-size:13px;color:var(--dim);margin-bottom:12px}
</style>
</head>
<body>

<h1>‚ö° DHR Leads</h1>

<div class="stats" id="stats"></div>

<div class="tabs">
  <button class="tab on" onclick="showTab('leads')">üë• Leads</button>
  <button class="tab" onclick="showTab('txs')">üí≥ Transa√ß√µes</button>
  <button class="tab" onclick="showTab('logs')">üìã Logs</button>
</div>

<!-- LEADS -->
<div class="panel on" id="p-leads">
  <div class="toolbar">
    <input type="text" id="leadQ" placeholder="Buscar nome, email, CPF, telefone..." style="width:280px" oninput="loadLeads()">
    <span class="chip on" onclick="setFilter(this,'')">Todos</span>
    <span class="chip" onclick="setFilter(this,'valid')">‚úì V√°lidos</span>
    <span class="chip" onclick="setFilter(this,'whatsapp')">üí¨ WhatsApp</span>
    <span class="chip" onclick="setFilter(this,'invalid')">‚úó Inv√°lidos</span>
    <span class="chip" onclick="setFilter(this,'no_phone')">Sem Tel.</span>
    <button class="btn btn-s" onclick="refresh()">‚Üª Atualizar</button>
    <button class="btn btn-g" id="pauseBtn" onclick="togglePause()">‚è∏Ô∏è Pausar</button>
  </div>
  <div class="count" id="leadCount"></div>
  <table>
    <thead><tr><th>Nome</th><th>Telefone</th><th>Status</th><th>WhatsApp</th><th>Email</th><th>Documento</th><th>Compras</th><th>Gasto</th><th>CRM</th></tr></thead>
    <tbody id="leadTbl"></tbody>
  </table>
</div>

<!-- TXS -->
<div class="panel" id="p-txs">
  <div class="toolbar">
    <input type="text" id="txQ" placeholder="Buscar..." style="width:240px" oninput="loadTxs()">
    <select id="txSt" onchange="loadTxs()"><option value="">Todas</option><option value="paid">Pagas</option><option value="pending">Pendentes</option></select>
    <button class="btn btn-s" onclick="refresh()">‚Üª Atualizar</button>
  </div>
  <table>
    <thead><tr><th>Data</th><th>Nome</th><th>Telefone</th><th>Email</th><th>Produto</th><th>Valor</th><th>Status</th><th>CRM</th></tr></thead>
    <tbody id="txTbl"></tbody>
  </table>
  <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
    <button class="btn btn-s" onclick="txPage=Math.max(1,txPage-1);loadTxs()">‚óÇ Anterior</button>
    <span id="txPag" style="font-size:12px;color:var(--dim)"></span>
    <button class="btn btn-s" onclick="txPage++;loadTxs()">Pr√≥xima ‚ñ∏</button>
  </div>
</div>

<!-- LOGS -->
<div class="panel" id="p-logs">
  <div class="log" id="logBox"></div>
</div>

<script>
const fmt = v => 'R$ ' + Number(v).toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
const esc = s => { if(!s) return ''; const d=document.createElement('div'); d.textContent=s; return d.innerHTML; };
const $ = id => document.getElementById(id);

let phoneFilter = '', txPage = 1, isPaused = false;

function showTab(name) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('on'));
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('on'));
  event.target.classList.add('on');
  $(`p-${name}`).classList.add('on');
  if (name === 'leads') loadLeads();
  if (name === 'txs') loadTxs();
  if (name === 'logs') loadLogs();
}

function setFilter(el, f) {
  document.querySelectorAll('.chip').forEach(c => c.classList.remove('on'));
  el.classList.add('on');
  phoneFilter = f;
  loadLeads();
}

function toast(msg) {
  const t = document.createElement('div'); t.className='toast'; t.textContent=msg;
  document.body.appendChild(t); setTimeout(()=>t.remove(),3000);
}

async function loadStats() {
  try {
    const s = await (await fetch('/api/stats')).json();
    isPaused = s.paused || false;
    updatePauseBtn();
    $('stats').innerHTML = `
      <div class="stat"><div class="stat-label">Transa√ß√µes</div><div class="stat-val b">${s.total}</div></div>
      <div class="stat"><div class="stat-label">Receita</div><div class="stat-val g">${fmt(s.revenue)}</div></div>
      <div class="stat"><div class="stat-label">Leads</div><div class="stat-val b">${s.leads}</div></div>
      <div class="stat"><div class="stat-label">Tel. V√°lidos</div><div class="stat-val g">${s.telValid}</div></div>
      <div class="stat"><div class="stat-label">WhatsApp</div><div class="stat-val g">${s.telWa}</div></div>
      <div class="stat"><div class="stat-label">Enviados CRM</div><div class="stat-val g">${s.crmSent || 0}</div></div>
      <div class="stat"><div class="stat-label">Auto-envio</div><div class="stat-val ${s.paused?'r':'g'}">${s.paused?'‚è∏Ô∏è PAUSADO':'‚ñ∂Ô∏è ATIVO'}</div></div>
    `;
  } catch(e) {}
}

async function loadLeads() {
  try {
    const q = $('leadQ')?.value || '';
    const leads = await (await fetch(`/api/leads?search=${encodeURIComponent(q)}&phoneFilter=${phoneFilter}`)).json();
    $('leadCount').textContent = `${leads.length} leads`;
    $('leadTbl').innerHTML = leads.map(l => `<tr>
      <td><b>${esc(l.nome)}</b></td>
      <td style="font-family:monospace;font-size:12px">${esc(l.telefone) || esc(l.telefoneRaw) || '<span class="empty">-</span>'}</td>
      <td>${l.telValido ? '<span class="ok">‚úì '+l.telMotivo+'</span>' : l.telefoneRaw ? '<span class="nok">‚úó '+l.telMotivo+'</span>' : '<span class="empty">sem tel.</span>'}</td>
      <td>${l.whatsapp ? `<a class="wa" href="https://wa.me/${l.whatsapp}" target="_blank">üí¨ ${l.whatsapp}</a>` : '-'}</td>
      <td style="font-size:12px;color:var(--dim)">${esc(l.email)}</td>
      <td style="font-family:monospace;font-size:11px">${esc(l.documento)}</td>
      <td>${l.comprasPagas}/${l.compras}</td>
      <td style="color:var(--green);font-weight:600">${fmt(l.totalGasto)}</td>
      <td>${l.sentCRM 
        ? '<span class="tag tag-g">‚úì Enviado</span>' 
        : l.paidTxIds?.length 
          ? `<button class="btn btn-g" style="padding:3px 8px;font-size:11px" onclick="sendCRM('${l.paidTxIds[l.paidTxIds.length-1]}')">üì§ Enviar</button>` 
          : '-'}</td>
    </tr>`).join('') || '<tr><td colspan="9" style="text-align:center;color:var(--dim);padding:40px">Nenhum lead encontrado</td></tr>';
  } catch(e) { console.error(e); }
}

async function loadTxs() {
  try {
    const q = $('txQ')?.value || '';
    const st = $('txSt')?.value || '';
    const j = await (await fetch(`/api/transactions?page=${txPage}&search=${encodeURIComponent(q)}&status=${st}`)).json();
    const p = j.pagination;
    $('txPag').textContent = `P√°gina ${p.page}/${p.totalPages} (${p.totalRecords} total)`;
    $('txTbl').innerHTML = j.data.map(t => {
      const c = t.customer || {};
      const st = t.status==='paid'?'tag-g':'tag-a';
      const stL = t.status==='paid'?'Pago':t.status==='waiting_payment'?'Pendente':t.status;
      return `<tr>
        <td style="font-size:12px;color:var(--dim)">${new Date(t.createdAt).toLocaleString('pt-BR')}</td>
        <td><b>${esc(c.name||'-')}</b></td>
        <td style="font-family:monospace;font-size:12px">${esc(c.phone||'-')}</td>
        <td style="font-size:12px;color:var(--dim)">${esc(c.email||'-')}</td>
        <td style="font-size:12px">${esc(t.items?.[0]?.title||'-').substring(0,40)}</td>
        <td style="color:var(--green);font-weight:600">${fmt((t.amount||0)/100)}</td>
        <td><span class="tag ${st}">${stL}</span></td>
        <td>${t.status==='paid'?`<button class="btn btn-g" style="padding:4px 10px;font-size:11px" onclick="sendCRM('${t.id}')">üì§ Enviar CRM</button>`:''}</td>
      </tr>`;
    }).join('');
  } catch(e) { console.error(e); }
}

async function loadLogs() {
  try {
    const logs = await (await fetch('/api/logs')).json();
    $('logBox').innerHTML = logs.map(l => `<div><span class="t">${new Date(l.time).toLocaleTimeString('pt-BR')}</span>${esc(l.msg)}</div>`).join('');
  } catch(e) {}
}

async function sendCRM(id) {
  toast('Enviando...');
  try {
    const j = await (await fetch(`/api/crm/send/${id}`, {method:'POST'})).json();
    if (j.success) toast('‚úì Enviado ao CRM!');
    else toast('Erro: ' + (j.error || j.status || 'falha'));
    loadAll();
  } catch(e) { toast('Erro: ' + e.message); }
}

async function togglePause() {
  const endpoint = isPaused ? '/api/resume' : '/api/pause';
  await fetch(endpoint, {method:'POST'});
  isPaused = !isPaused;
  updatePauseBtn();
  toast(isPaused ? '‚è∏Ô∏è Envios pausados' : '‚ñ∂Ô∏è Envios retomados');
  loadStats();
}

function updatePauseBtn() {
  const btn = $('pauseBtn');
  if (isPaused) { btn.textContent = '‚ñ∂Ô∏è Retomar'; btn.style.background = '#3b82f6'; }
  else { btn.textContent = '‚è∏Ô∏è Pausar'; btn.style.background = 'var(--green)'; }
}

async function refresh() {
  toast('Atualizando...');
  await fetch('/api/refresh', {method:'POST'});
  toast('‚úì Atualizado');
  loadAll();
}

function loadAll() { loadStats(); loadLeads(); }
loadAll();
setInterval(loadAll, 15000);
</script>
</body>
</html>
